<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>弹幕（头像，文字）</title>
</head>

<body style="background-color: black;">
  <canvas id="canvas"></canvas>
  <canvas id="ccc" width="400" height="400" style="border: 1px solid #fff;"></canvas>
</body>
<script>
  var cc = document.getElementById('ccc');
  var cctx = cc.getContext('2d');



  CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
    const pi = Math.PI;
    this.beginPath();
    this.arc(x + r, y + r, r, -pi, -pi / 2);
    this.arc(x + w - r, y + r, r, -pi / 2, 0);
    this.arc(x + w - r, y + h - r, r, 0, pi / 2);
    this.arc(x + r, y + h - r, r, pi / 2, pi);
    this.closePath();
  }

  class Barrage {
    constructor(canvasId) {
      this.c = document.getElementById(canvasId);
      this.c.width = document.body.offsetWidth;
      this.c.height = 200;
      this.w = this.c.width;
      this.h = this.c.height;
      this.ctx = this.c.getContext('2d');
      this.ctx.font = '24px 宋体 PingFangSC-Regular';

      this.barrageList = [];
    }

    shoot(value) {
      let top = this.getTop();
      let color = this.getColor();
      let offset = this.getOffset();
      let width = Math.ceil(this.ctx.measureText(value).width);

      let barrage = {
        value,
        top,
        color,
        left: this.w,
        offset,
        width,
      }

      this.barrageList.push(barrage);

    }

    draw() {
      if (!!this.barrageList.length) {
        this.ctx.clearRect(0, 0, this.w, this.h);
        for (let i = 0, barrage; barrage = this.barrageList[i]; i++) {
          barrage.left -= barrage.offset;
          this.drawContent(barrage);
        }
      }
      requestAnimationFrame(this.draw.bind(this));
    }

    drawContent(barrage) {
      const {
        value: { img, t1, t2 },
        top,
        color,
        left,
        offset,
        width,
      } = barrage;


      let t1_width = Math.ceil(this.ctx.measureText(t1).width);
      let t2_width = Math.ceil(this.ctx.measureText(t2).width);

      // 背景框子
      // this.ctx.drawImage(img, 0, 0, img.width, img.height, left, top - 24, 34 + t1_width + 2 + t2_width, 30);
      this.ctx.roundRect(left, top - 24, 34 + t1_width + 2 + t2_width, 30, 15)
      this.ctx.fillStyle = 'rgba(255,255,255,0.50)';
      this.ctx.fill();
      // 画头像
      this.ctx.drawImage(img, 0, 0, img.width, img.height, left, top - 24, 28, 28);
      // 画黑色的字
      this.ctx.fillStyle = color;
      this.ctx.fillText(t1, left + 34, top);
      // 画红色的字
      this.ctx.fillStyle = '#F24949';
      this.ctx.fillText(t2, left + 34 + t1_width + 2, top);


    }

    getTop() {
      return Math.floor(Math.random() * this.h);
    }

    getColor() {
      return '#000000';
    }

    getOffset() {
      return 2;
    }
  }

  var index = 0;
  var shootBarrage = function (list) {
    setTimeout(function () {
      var data = list[index++] || list[index = 0 && index++];
      if (data.img) {
        barrage.shoot(data);
      } else {
        var img = new Image();
        img.setAttribute("crossOrigin", 'anonymous');  // 跨域
        img.onload = function () {
          data.img = img;
          barrage.shoot(data);
        }
        img.src = data.avatar;
      }
      shootBarrage(list)
    }, 2000)
  }


  var barrage = new Barrage('canvas');
  barrage.draw();

  var list = [
    {
      avatar: 'https://image.duliday.com/living-cost/20200303/2a94df636b91ad15bbbb4408e2f285e4164115',
      t1: '张** 获得了',
      t2: '500元',
    },
    {
      avatar: 'https://image.duliday.com/living-cost/20200303/2a94df636b91ad15bbbb4408e2f285e4164115',
      t1: '李** 获得了',
      t2: '200元',
    },
    {
      avatar: 'https://image.duliday.com/living-cost/20200303/2a94df636b91ad15bbbb4408e2f285e4164115',
      t1: '王** 获得了',
      t2: '100元',
    },
  ]

  shootBarrage(list);



</script>

</html>