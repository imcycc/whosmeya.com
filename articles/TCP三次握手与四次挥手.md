# TCP三次握手与四次挥手

## 三次握手

1. 客户端发送SYN（seq=x）报文给服务器端，进入SYN_SEND状态。
2. 服务器端收到SYN报文，回应一个SYN（seq=y）ACK（x+1）报文，进入SYN_RECV状态。
3. 客户端收到服务器端的SYN报文，回应一个ACK（y+1）报文，进入Established状态。

在三次握手协议中，服务器维护一个未连接队列，该队列为每个客户端的SYN包（seq=x）开设一个条目，该条目表明服务器已收到SYN包，并向客户发出确认，正在等待客户的确认包。当服务器收到客户的确认包时，删除该条目。如果未收到客户确认包，循环重传，如果重传次数超过系统规定的最大重传次数，删除该条目。

* SYN：同步序列编号（Synchronize Sequence Numbers）。
* ACK (Acknowledge character）即是确认字符，在数据通信中，接收站发给发送站的一种传输类控制字符。表示发来的数据已确认接收无误。

### 为什么不是两次握手

为了防止无效的连接请求报文到达B服务机。

因为有可能A先发了一个连接请求报文，但是由于网络的1问题，迟迟没有到达B主机，这时候，A主机就超时重传了该报文，然后B主机响应了该请求报文，但是不妙了，第一个报文居然又到了B主机，那么B主机就会把它作为新的连接请求，如果只有两次握手，那么B主机对于该连接请求也会建立连接，但是如果是三次握手，B主机发出确认报文后，A主机不予理睬，这样就不会建立TCP连接了。

## 四次挥手

由于TCP连接是全双工的，因此每个方向都必须单独进行关闭。这原则是当一方完成它的数据发送任务后就能发送一个FIN来终止这个方向的连接。收到一个 FIN只意味着这一方向上没有数据流动，一个TCP连接在收到一个FIN后仍能发送数据。首先进行关闭的一方将执行主动关闭，而另一方执行被动关闭。

1. TCP客户端发送一个FIN，用来关闭客户到服务器的数据传送。
2. 服务器收到这个FIN，它发回一个ACK，确认序号为收到的序号加1。和SYN一样，一个FIN将占用一个序号。
3. 服务器关闭客户端的连接，发送一个FIN给客户端。
4. 客户端发回ACK报文确认，并将确认序号设置为收到序号加1。

<img style="width: 500px;" src="https://img2020.cnblogs.com/blog/1141466/202102/1141466-20210219180523277-1262062259.png" />
